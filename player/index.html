<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Starlight Sound Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <style>
    body { background:#1a1a2e; color:white; }

    .player-box {
      background:#27273f;
      border:1px solid #3d3d5f;
      border-radius:14px;
      padding:20px;
    }

    .song-title-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      font-weight:600;
      color:#9aa4ff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .explicit-tag {
      background:#5d3587;
      color:white;
      font-size:.75rem;
      padding:1px 4px;
      border-radius:3px;
      font-weight:700;
      margin-left:10px;
      flex-shrink:0;
    }

    .controls { display:flex; align-items:center; gap:15px; }

    .icon-btn { font-size:1.4rem; cursor:pointer; color:white; }
    .icon-btn:hover { color:#9aa4ff; }

    .progress { height:6px; cursor:pointer; flex-grow:1; }

    .progress-bar { transition:width 0.1s linear; }

    .list-group-item {
      background:#1f1f33;
      border-color:#3d3d5f;
      cursor:pointer;
    }

    .list-group-item:hover { background:#3d3d5f; }

    .list-item-title {
      flex-grow:1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
  </style>
</head>

<body>

<nav class="container mb-4">
  <ul class="nav nav-tabs justify-content-center">
    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
    <li class="nav-item"><a class="nav-link active" href="/">Player</a></li>
    <li class="nav-item"><a class="nav-link" href="/request">Request Form</a></li>
  </ul>
</nav>

<div class="container py-4">

  <h1 class="text-center text-primary fw-bold mb-3">
    Starlight Sound Player
  </h1>

  <!-- CLEAN TOGGLE -->
  <div class="d-flex justify-content-center mb-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="cleanToggle">
      <label class="form-check-label" for="cleanToggle">
        Clean
      </label>
    </div>
  </div>

  <!-- PLAYER -->
  <div class="player-box mb-4">

    <div id="nowPlaying" class="song-title-row">
      <span class="list-item-title">Nothing playing</span>
      <span class="explicit-tag" style="display:none;">E</span>
    </div>

    <div class="controls">
      <i id="playPause" class="bi bi-play-fill icon-btn"></i>
      <i id="loopBtn" class="bi bi-arrow-repeat icon-btn opacity-50" title="Loop"></i>
      <div class="progress" id="progressBar">
        <div class="progress-bar bg-primary" id="progress"></div>
      </div>
    </div>
  </div>

  <!-- UPLOAD -->
  <div class="mb-4">
    <label class="form-label">Upload a song</label>
    <input type="file" id="upload" class="form-control" accept="audio/*">
  </div>

  <!-- LIBRARY -->
  <h5 class="text-secondary mb-2">Library</h5>
  <ul class="list-group" id="library"></ul>

</div>

<audio id="audio"></audio>

<script src="/starlight.js"></script>

<script>
  const audio = document.getElementById('audio');
  const playPause = document.getElementById('playPause');
  const loopBtn = document.getElementById('loopBtn');
  const progress = document.getElementById('progress');
  const progressBar = document.getElementById('progressBar');
  const nowPlaying = document.getElementById('nowPlaying');
  const titleSpan = nowPlaying.querySelector('.list-item-title');
  const explicitSpan = nowPlaying.querySelector('.explicit-tag');
  const upload = document.getElementById('upload');
  const library = document.getElementById('library');
  const cleanToggle = document.getElementById('cleanToggle');

  // load saved state
  let cleanMode = localStorage.getItem('cleanEnabled') === 'true';
  cleanToggle.checked = cleanMode;

  let currentSong = null;

  function getSongFile(song) {
    if (cleanMode && song.file_clean) return song.file_clean;
    return song.file;
  }

  function setNowPlaying(text, isExplicit) {
    titleSpan.textContent = text;
    explicitSpan.style.display = isExplicit ? 'inline-block' : 'none';
  }

  playPause.onclick = () => audio.paused ? audio.play() : audio.pause();
  audio.onplay = () => playPause.className = 'bi bi-pause-fill icon-btn';
  audio.onpause = () => playPause.className = 'bi bi-play-fill icon-btn';

  loopBtn.onclick = () => {
    audio.loop = !audio.loop;
    loopBtn.classList.toggle('opacity-50', !audio.loop);
    loopBtn.classList.toggle('text-primary', audio.loop);
  };

  audio.ontimeupdate = () => {
    if (!audio.duration) return;
    progress.style.width = `${(audio.currentTime / audio.duration) * 100}%`;
  };

  progressBar.onclick = e => {
    const rect = progressBar.getBoundingClientRect();
    audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
  };

  upload.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    currentSong = null;
    audio.src = URL.createObjectURL(file);
    setNowPlaying(file.name, false);
    audio.play();
  };

  cleanToggle.onchange = () => {
    cleanMode = cleanToggle.checked;
    localStorage.setItem('cleanEnabled', cleanMode);

    if (currentSong) {
      audio.src = `../${getSongFile(currentSong)}`;
      audio.play();
    }
  };

  window.STARLIGHT_SONGS.forEach(song => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex align-items-center';
    li.innerHTML = `
      <span class="list-item-title">${song.title} - ${song.artist}</span>
      ${song.isExplicit ? '<span class="explicit-tag">E</span>' : ''}
    `;

    li.onclick = () => {
      currentSong = song;
      audio.src = `../${getSongFile(song)}`;
      setNowPlaying(`${song.title} - ${song.artist}`, song.isExplicit);
      audio.play();
    };

    library.appendChild(li);
  });
</script>
</body>
</html>
